<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
<meta name="description" content="">
<meta name="author" content="">
<title>Wellnowhealth</title>

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="css/bootstrap.min.css">
<!-- /Bootstrap CSS -->

<!-- Font Awesome CSS -->
<link rel="stylesheet" href="css/font-awesome.min.css">
<!-- /Font Awesome CSS -->

<!-- Custom Style CSS -->
<link rel="stylesheet" href="css/slidenav.css">
<!-- /Custom Style CSS -->

<!-- Common Style CSS -->
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/mycss.css">
<!-- /Common Style CSS -->

<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>

<div class="full-height background-layer"> 
    
    <!-----Header Start------->
    <header class="header container-fluid">
        <div class="container"> <a href="current-emergencies.html" class="header-back-btn"><i  class="fa fa-angle-left"></i> </a>
            <div class="logo"><a href="your-location.html"><img src="images/logo.png"  alt=""></a></div>
        </div>
    </header>
    <!-----Header End-------> 
    
    <!-----Main wrapper Start------->
    <div class="main-wrapper mt-5 p-dtl-main">
        <div class="container">
         <h1 class="entry-title text-center text-white">Location Detail</h1>
		 <p class="displaydistance" style="margin-top:-15px;"></p>
        </div>
     <div class="location-map mb-4"><div id="ourgmap"></div></div>   
        
    </div>
    <!-----Main wrapper End-------> 
    
</div>
<div class="modal fade" id="emergency" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-primary text-white"> 
            
             <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
            
            <div class="modal-body">
                <form id="loginuser" action="" method="post">
					<input type="hidden" name="company_id" value="0">
					<input type="hidden" name="clinic_id" value="0">
					<input type="hidden" name="emergency_id" value="0">
					
					<input type="hidden" name="add_by" value="company">
					<input type="hidden" name="manager_id" value="0">
					<div class="notelists"></div>
                    <div class="mb-3">
					   <div>
						<textarea name="note" rows="4" cols="50" class="form-control required"></textarea>
					  </div>
                    </div>
                    <div  class="submitwrap">
                        
                        <div class="pull-left camebtns"><a class="phone-anch" href="javascript:;" id="uploadphoto1"><i class="fa fa-camera"></i><span>Photo</span></a>
				<a class="phone-anch" href="javascript:;" id="uploadphoto12"><i class="fa fa-picture-o"></i><span>Gallery</span></a>
				<a class="phone-anch" href="javascript:;" id="uploadphoto13"><img src="images/video1.png"/><span>Video</span></a></div>
					<div class="pull-right">
                            <button type="submit" class="sendmsgbtn" disabled="disabled" style="background:transparent; border:none;"><img src="images/send.png" /></button>
                        </div>
                    </div>
                </form>  
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="confirmuploadvideo" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-primary emergency-popup">
            <div class="modal-body" style="border:1px solid #fff;">
                <input type="hidden" id="uploadvideopath" value="" />
				<h2>Do you want to upload this video?</h2>
				<div style="width:125px; margin:0px auto;">
                 <h2> <a href="javascript:;" onClick="uploadmyvideo();" style="float:left; border:1px solid #FFFFFF; border-radius:5px; padding:3px 5px;">Yes</a><a href="javascript:;" onClick="uploadgalleryvideo();" style="float:right; border:1px solid #FFFFFF; border-radius:5px; padding:3px 5px;">No</a></h2>   </div>
            </div> 
        </div>
    </div>
</div>
<div class="modal fade" id="playvideos" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content bg-primary text-white"> 
            
             <button type="button" class="close" onClick="closevideo();">
          <span aria-hidden="true">&times;</span>
        </button>
            
            <div class="modal-body">
                
            </div>
        </div>
    </div>
</div>
<script src="js/jquery-3.2.1.min.js" ></script>
<script src="js/popper.min.js" ></script>
<script src="js/bootstrap.min.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
	<script type="text/javascript" src="js/config.js"></script>
	<script type="text/javascript" src="js/queries.js"></script>
	<script type="text/javascript" src="js/validate.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?sensor=true&libraries=geometry&key=AIzaSyAdRw4y6QbeCa2AVoQcI_j7NMQZPYDrabU" type="text/javascript"></script>
<script>
  function openNav() {
      document.getElementById("mySidenav").style.width = "100%";
  }

  function closeNav() {
      document.getElementById("mySidenav").style.width = "0";
  }
  
</script>
<script type="text/javascript">
var ourphoto='images/home.png';
var crrentdata=[];
var activedata=[];
var quenotes=[];

function checkseenmsg(){
	var seenmsgs=localStorage.getItem('seenmsgs');
	var seenmsgs_ids='';
	if(typeof seenmsgs!='undefined' && seenmsgs!='' && seenmsgs!=null){
		seenmsgs_ids=seenmsgs;
	}
	var emergency_id=gup('id');
	if(emergency_id!='' && emergency_id!='0'){
		db.transaction(showlistjobs3, errorDB, successDB);
		function showlistjobs3(tx){
			var q="SELECT * FROM wnh_emergency_notes where emergency_id=? AND readbymanager=?";
			var cond=[emergency_id,'1'];
			tx.executeSql(q, cond, function(tx, res){
				if(parseInt(res.rows.length)>0){
					for(var i = 0; i < res.rows.length; i++)
					{
						jQuery('.seen_'+res.rows.item(i).emergency_note_id).removeClass('notseenmsg');
						jQuery('.seen_'+res.rows.item(i).emergency_note_id).addClass('seenmsg');
					}
					if(jQuery('.notelists .note-content:first span').hasClass('notseenmsg')){
						jQuery('.notelists .note-content:first span.notseenmsg').addClass('seenmsg');
						jQuery('.notelists .note-content:first span').removeClass('notseenmsg');
					}
				}
			});
		}
	}
}

function opennotes(showmsg){
	var emergency_id=gup('id');
	//jQuery('.notelists').html('');
	db.transaction(showlistjobs1, errorDB, successDB);
	function showlistjobs1(tx){
		var q="SELECT * FROM wnh_emergencies where emergency_id=?";
		var cond=[emergency_id];
		//jQuery('.notelists').html('');
		tx.executeSql(q, cond, function(tx, res){
			if(parseInt(res.rows.length)>0){
				for(var i = 0; i < res.rows.length; i++)
				{
					
					var q="SELECT n.*, m.name as manager FROM wnh_emergency_notes as n, wnh_managers as m, wnh_emergencies as e where e.emergency_id=n.emergency_id and e.manager_id=m.manager_id and n.emergency_id=?";
					var cond=[emergency_id];
					tx.executeSql(q, cond, function(tx, res2){
						if(parseInt(res2.rows.length)>0){
							for(var i = 0; i < res2.rows.length; i++)
							{
								var chkque=quenotes.indexOf(res2.rows.item(i).emergency_note_id);
								//alert(chkque);
								if(chkque==-1){
									//alert(res2.rows.item(i).note);
									quenotes.push(res2.rows.item(i).emergency_note_id);
									var clsas='clinicnote';
									var note=res2.rows.item(i).note;
									if(jQuery.trim(note)=='' && jQuery.trim(res2.rows.item(i).filetype)!=''){
										var filepath=res2.rows.item(i).mobilefilepath;
										if(jQuery.trim(filepath)==''){
											filepath=res2.rows.item(i).filepath;
										}
										if(jQuery.trim(res2.rows.item(i).filetype)=='video'){
											note='<span class="video-wrape"><a href="javascript:;" onclick="return showvideo(\''+filepath+'\');"><img src="images/video1.png" alt="video" /> Click to view</a></span>';
										}
										else if(jQuery.trim(res2.rows.item(i).filetype)=='image'){
											note='<span class="img-wrape"><a href="javascript:;" onclick="return showimg(\''+filepath+'\');"><i class="fa fa-picture-o" style="font-size:18px;"></i> Click to zoom</a></span>';
										}
									}
									var msgg=note+' <span class="seen_'+res2.rows.item(i).emergency_note_id+' notseenmsg"></span>';
									if(res2.rows.item(i).manager_id!='0'){
										msgg=res2.rows.item(i).note+' :'+res2.rows.item(i).manager;
										clsas='managernote';
									}
									jQuery('.notelists').append('<div class="note-content"><span class="'+clsas+'">'+msgg+'</span></div>');
									showmsg='yes';
								}
								
							}
						}
					});
				}
			}
		});
		if(showmsg=='yes'){
			jQuery('#emergency').modal();
		}
		if(typeof inter2!='undefined'){
			clearInterval(inter2);
		}
		var inter2=setInterval(checkseenmsg,2000);
		return false;
		
	}
	if(typeof inter!='undefined'){
		clearInterval(inter);
	}
	var inter=setInterval(notes,5000);
}

function notes(){
	var emergency_id=gup('id');
	var url=siteurl+'/api/emergencies/getsinglemsgs';
	 jQuery.ajax({  
	 type: 'POST',  
	 url: url,           
	 dataType: 'json',  
	 data: {emergency_id:emergency_id,seeby:'company'}, 
	 beforeSend: function() {
		
	 },		
	 complete: function() {
	 }, 
	 crossDomain: true,  
	 success: function(res) { 
	 	//alert(JSON.stringify(res));
		if(res['notes'] && jQuery.trim(res['notes'])!='')
		{
			jQuery(res['notes']).each(function(index){
				var clsas='clinicnote';
				var msgg=res['notes'][index]['note'];
				if(jQuery.trim(res['notes'][index]['manager'])!=''){
					msgg=res['notes'][index]['note']+' :'+res['notes'][index]['manager'];
					clsas='managernote';
				}
				else{
					msgg=res['notes'][index]['note'];
				}
				jQuery('.notelists').append('<div class="note-content"><span class="'+clsas+'">'+msgg+'</div>');
				
				db.transaction(function(tx){
					var qr='INSERT INTO wnh_emergency_notes (emergency_note_id, emergency_id, note, filepath, filetype, manager_id, company_id, cdate, readbycompany, readbymanager, parent_id, notify,mobilefilepath) VALUES ("'+res['notes'][index]['emergency_note_id']+'", "'+emergency_id+'", "'+res['notes'][index]['note']+'", "'+res['notes'][index]['filepath']+'", "'+res['notes'][index]['filetype']+'", "'+res['notes'][index]['manager_id']+'", "'+res['notes'][index]['company_id']+'", "'+res['notes'][index]['cdate']+'", "'+res['notes'][index]['readbycompany']+'", "'+res['notes'][index]['readbymanager']+'", "'+res['notes'][index]['parent_id']+'", "'+res['notes'][index]['notify']+'","")';
					tx.executeSql(qr);
					//opennotes('yes');
					jQuery('#emergency').modal();
					
				});
			});
			
		
		}
		if(typeof res['measurement']!='undefined' && typeof res['measurement']['distance']!='undefined'){
			jQuery('.displaydistance').html('Estimated Distance : '+res['measurement']['distance']+'<br>Estimated Time: '+res['measurement']['duration']);
		}
		if(typeof res['emstatus']!='undefined' && res['emstatus']!=''){
			var emstatus=res['emstatus'];
			db.transaction(function(tx){
				var qr="UPDATE wnh_emergencies SET status='"+emstatus+"' WHERE emergency_id='"+emergency_id+"'";
				tx.executeSql(qr);
				if(emstatus=='completed')
				{
					window.location='emergancy-detail.html?id='+emergency_id;
				}
			});
			
		}
		
		return false; 
	 },  
	 error: function(response, d, a){
		
		/*jQuery('body .showmessage').remove();
		var html='<div class="showmessage">Server Error.</div>';
		jQuery('body').append(html);
		setTimeout(function(){jQuery('.showmessage').slideUp();},1000);
		return false; */
	 }
			
   });
}
jQuery(document).ready(function(){
	jQuery( document ).on( "mobileinit", function() {
		jQuery.mobile.allowCrossDomainPages = true;
	});
	var contentType ="application/x-www-form-urlencoded; charset=utf-8";
    if(window.XDomainRequest){contentType = "text/plain";}
	jQuery.support.cors = true;
	var id=gup('id');
	jQuery('textarea[name="note"]').keyup(function(){
		var vl=jQuery(this).val();
		if(jQuery.trim(vl)!=''){
			jQuery('.sendmsgbtn').attr('disabled',false);
		}
		else{
			jQuery('.sendmsgbtn').attr('disabled',true);
		}
	});
	var uid=localStorage.getItem('Company_ID');
	jQuery('input[name="emergency_id"]').val(id);
	jQuery('input[name="company_id"]').val(uid);
	var our_address='';
	
	var setgooglepath=function(joblati,joblongi, jobaddress,our_address, mapid) {
		var showaddress1=jobaddress;
		var showaddress2=our_address;
		our_address=localStorage.getItem('Current_Manager_clinicaddress');
        var directionsDisplay = new google.maps.DirectionsRenderer({suppressMarkers:true});
        var directionsService = new google.maps.DirectionsService;
		if(jQuery.trim(activedata['stff_lati'])!='' && jQuery.trim(activedata['staff_longi'])!=''){
			our_address={lat: parseFloat(activedata['stff_lati']), lng: parseFloat(activedata['staff_longi'])};
		}
		if(jQuery.trim(activedata['company_lati'])!='' && jQuery.trim(activedata['company_longi'])!=''){
			jobaddress={lat: parseFloat(activedata['company_lati']), lng: parseFloat(activedata['company_longi'])};
			joblati=parseFloat(activedata['company_lati']);
			joblongi=parseFloat(activedata['company_longi']);
		}
        var map = new google.maps.Map(document.getElementById(mapid), {
          zoom: 12,
          center: our_address
        });
        directionsDisplay.setMap(map);
		
		var geocoder = new google.maps.Geocoder;
		var infowindow = new google.maps.InfoWindow;
		var latlng = our_address;
		
		var marker = new google.maps.Marker({
			position: latlng,
			map: map,
			animation: google.maps.Animation.DROP,
			icon: ourphoto
		});
	  marker.setPosition( latlng );
	   google.maps.event.addListener(marker, "click", function (e) {
			var infoWindow = new google.maps.InfoWindow();
			infoWindow.setContent(showaddress2);
			infoWindow.open(map, marker);
		});
		
		var imgommap='images/mapicon.png';
		var latlng2=jobaddress;
		var marker2 = new google.maps.Marker({
			position: latlng2,
			map: map,
			animation: google.maps.Animation.DROP,
			icon: imgommap
		});
	  marker2.setPosition( latlng2 );
	 
	  google.maps.event.addListener(marker2, "click", function (e) {
			var infoWindow = new google.maps.InfoWindow();
			infoWindow.setContent(showaddress1);
			infoWindow.open(map, marker2);
		});
		
	
		directionsService.route({
          origin: our_address,  
          destination: jobaddress,  
          travelMode: google.maps.TravelMode.DRIVING
        }, function(response, status) {
          if (status == 'OK') {
            directionsDisplay.setDirections(response);
          } else {
            //window.location='';
          }
        });
        
      }
	
	
	function loademergency(id){
		db.transaction(showlistjobs2, errorDB, successDB);
		function showlistjobs2(tx){
			var q="SELECT e.note,m.phone,m.image, c.address_lati as clinic_lati, c.address_longi as clinic_longi, c.address as clinic_address, cm.*, e.manager_id, e.clinic_id FROM wnh_emergencies as e, wnh_managers as m, wnh_clinics as c, wnh_company as cm where e.manager_id=m.manager_id AND e.clinic_id=c.clinic_id AND e.company_id=cm.company_id AND e.emergency_id=?";
			//alert(q);
			var cond=[id];
			tx.executeSql(q, cond, function(tx, res){
				if(parseInt(res.rows.length)>0){
					var html='';
					for(var i = 0; i < res.rows.length; i++)
					{
						var phone=res.rows.item(i).phone;
						if(jQuery.trim(phone)!=''){
							//jQuery('.main-wrapper').append('<div class="btm-btn-sctn"><div class="text-center mb-3"><a href="tel:'+phone+'" class="btn btn-primary">CONTACT EMERGENCY</a></div><div class="text-center mb-3"><a href="javascript:;" onclick="return opennotes();" class="btn btn-primary">MESSAGES</a></div></div>');
							
							var clsas='clinicnote';
							var note=res.rows.item(i).note;
							if(jQuery.trim(note)=='' && jQuery.trim(res.rows.item(i).filetype)!=''){
								var filepath=res.rows.item(i).mobilefilepath;
								if(jQuery.trim(filepath)==''){
									filepath=res.rows.item(i).filepath;
								}
								if(jQuery.trim(res.rows.item(i).filetype)=='video'){
									note='<span class="video-wrape"><a href="javascript:;" onclick="return showvideo(\''+filepath+'\');"><img src="images/video1.png" alt="video" /> Click to view</a></span>';
								}
								else if(jQuery.trim(res.rows.item(i).filetype)=='image'){
									note='<span class="img-wrape"><a href="javascript:;" onclick="return showimg(\''+filepath+'\');"><i class="fa fa-picture-o" style="font-size:18px;"></i> Click to zoom</a></span>';
								}
							}
							var msgg=note+' <span class="seen_'+res.rows.item(i).emergency_note_id+' notseenmsg"></span>';
							jQuery('.notelists').append('<div class="note-content"><span class="'+clsas+'">'+msgg+'</span></div>');
							
							jQuery('.main-wrapper').append('<div class="btm-btn-sctn"><div class="text-center mb-3"><a href="tel:'+phone+'" class="btn btn-primary">CONTACT EMERGENCY</a></div><div class="text-center mb-3"><a href="javascript:;" onclick="return opennotes(\'yes\');" class="btn btn-primary">MESSAGES</a></div></div>');
						}
						if(res.rows.item(i).manager_id=='0'){
							jQuery('body .showmessage').remove();
							var html='<div class="showmessage">Please wait the Manager is not logged in</div>';
							jQuery('body').append(html);
							setTimeout(function(){jQuery('.showmessage').slideUp();
							},2000);
							setTimeout(function(){
								window.location='';
							},5000);
						}
						jQuery('input[name="manager_id"]').val(res.rows.item(i).manager_id);
			  			jQuery('input[name="clinic_id"]').val(res.rows.item(i).clinic_id);
				
						localStorage.setItem('Current_Manager_clinic_lati',res.rows.item(i).clinic_lati);
						localStorage.setItem('Current_Manager_clinic_longi',res.rows.item(i).clinic_longi);
						localStorage.setItem('Current_Manager_clinicaddress',res.rows.item(i).clinic_address);
						our_address=res.rows.item(i).clinic_address;
						//crrentdata=res['data'][index]['otherstff'];
						activedata['stff_lati']=res.rows.item(i).clinic_lati;
						activedata['staff_longi']=res.rows.item(i).clinic_longi;
						activedata['company_lati']=res.rows.item(i).current_lati;
						activedata['company_longi']=res.rows.item(i).current_longi;
						
						var mapimage=realsiteurl+'uploads/profile/'+res.rows.item(i).image;
						//alert(res.rows.item(i).clinic_lati+', '+res.rows.item(i).clinic_longi+', '+res.rows.item(i).clinic_address);
						if(jQuery.trim(res.rows.item(i).image)!=''){ourphoto=mapimage;}
						var lati=res.rows.item(i).current_lati, 
							longi=res.rows.item(i).current_longi,
							address=res.rows.item(i).current_address, 
							mapid='ourgmap';
						setTimeout(function(){
							setgooglepath(lati,longi, address,our_address, mapid);
							opennotes('no');
						},1000);
						
					}
				}
				else{
					jQuery('body .showmessage').remove();
					var html='<div class="showmessage">Please wait the Manager is not logged in</div>';
					jQuery('body').append(html);
					setTimeout(function(){jQuery('.showmessage').slideUp();
					},2000);
					setTimeout(function(){
						window.location='';
					},5000);
				}
			});
		}
	}
	loademergency(id);
	jQuery('#loginuser').submit( function(){	
		var error=false;
		jQuery('#loginuser input.required').each(function(){
			var v=jQuery(this).val();
			if(jQuery.trim(v)==''){
				jQuery(this).addClass('error');
				error=true;
			}
			else{
				jQuery(this).removeClass('error');
			}
		});
		jQuery('#loginuser textarea.required').each(function(){
			var v=jQuery(this).val();
			if(jQuery.trim(v)==''){
				jQuery(this).addClass('error');
				error=true;
			}
			else{
				jQuery(this).removeClass('error');
			}
		});
		var url=siteurl+'/api/emergencies/addemergencymsg';
		if(error)
		{
			return false;
		}
		else
		{
			var msg=jQuery('#loginuser textarea[name="note"]').val();
			 jQuery.ajax({  
			 type: 'POST',  
			 url: url,           
			 dataType: 'json',  
			 data: jQuery('#loginuser').serialize(), 
			 beforeSend: function() {
			 	
			 },		
			 complete: function() {
			 }, 
			 crossDomain: true,  
			 success: function(res) { 
				if(res['msg'])
				{
					jQuery('.notelists').append('<div class="note-content"><span class="clinicnote">'+msg+'<span class="seen_'+res['emergency_id']+' notseenmsg"></span></span></div>');
					jQuery('body .showmessage').remove();
					var html='<div class="showmessage">'+res['msg']+'</div>';
					jQuery('body').append(html);
					setTimeout(function(){jQuery('.showmessage').slideUp();},3000);
					jQuery('#loginuser textarea[name="note"]').val('');
					jQuery('.sendmsgbtn').attr('disabled',true);
					
					jQuery(res['emnotes']).each(function(index){
						
						db.transaction(function(tx){
							var qr='INSERT INTO wnh_emergency_notes (emergency_note_id, emergency_id, note, filepath, mobilefilepath, filetype, manager_id, company_id, cdate, readbycompany, readbymanager, parent_id, notify, mobilefilepath) VALUES ("'+res['emnotes'][index]['id']+'", "'+res['emnotes'][index]['emergency_id']+'", "'+res['emnotes'][index]['note']+'", "'+res['emnotes'][index]['filepath']+'", "", "'+res['emnotes'][index]['filetype']+'", "'+res['emnotes'][index]['manager_id']+'", "'+res['emnotes'][index]['company_id']+'", "'+res['emnotes'][index]['cdate']+'", "1", "'+res['emnotes'][index]['readbymanager']+'", "'+res['emnotes'][index]['parent_id']+'", "'+res['emnotes'][index]['notify']+'","")';
							tx.executeSql(qr);
							quenotes.push(res['emnotes'][index]['id']);
							
						});
					});
				
				}else if(res['errors']){				
					/*jQuery('body .showmessage').remove();
					var html='<div class="showmessage">'+res['error']+'</div>';
					jQuery('body').append(html);
					setTimeout(function(){jQuery('.showmessage').slideUp();},3000);*/
				}
				else
				{
					alert('Server error');
				}
				return false; 
			 },  
			 error: function(response, d, a){
				
				/*jQuery('body .showmessage').remove();
				var html='<div class="showmessage">Server Error.</div>';
				jQuery('body').append(html);
				setTimeout(function(){jQuery('.showmessage').slideUp();},1000);
				return false; */
			 }
			        
		   });
		 }	
		 return false;   
	});
});
function getgallerysinglenote(note_id,mobilefilepath){
	var url=siteurl+'/api/emergencies/getsinglenote';
	 jQuery.ajax({  
	 type: 'POST',  
	 url: url,           
	 dataType: 'json',  
	 data: {note_id:note_id}, 
	 beforeSend: function() {
		
	 },		
	 complete: function() {
	 }, 
	 crossDomain: true,  
	 success: function(res) { 
		if(res['emnotes'])
		{
			jQuery(res['emnotes']).each(function(index){
				db.transaction(function(tx){
					var qr='INSERT INTO wnh_emergency_notes (emergency_note_id, emergency_id, note, filepath, mobilefilepath, filetype, manager_id, company_id, cdate, readbycompany, readbymanager, parent_id, notify) VALUES ("'+res['emnotes'][index]['id']+'", "'+res['emnotes'][index]['emergency_id']+'", "'+res['emnotes'][index]['note']+'", "'+res['emnotes'][index]['filepath']+'", "'+mobilefilepath+'", "'+res['emnotes'][index]['filetype']+'", "'+res['emnotes'][index]['manager_id']+'", "'+res['emnotes'][index]['company_id']+'", "'+res['emnotes'][index]['cdate']+'", "1", "'+res['emnotes'][index]['readbymanager']+'", "'+res['emnotes'][index]['parent_id']+'", "'+res['emnotes'][index]['notify']+'")';
					tx.executeSql(qr);
					quenotes.push(note_id);
					
				});
			});
		
		}else if(res['errors']){				
			jQuery('body .showmessage').remove();
			var html='<div class="showmessage">'+res['error']+'</div>';
			jQuery('body').append(html);
			setTimeout(function(){jQuery('.showmessage').slideUp();},3000);
		}
		else
		{
			alert('Server error');
		}
		return false; 
	 },  
	 error: function(response, d, a){
		
		/*jQuery('body .showmessage').remove();
		var html='<div class="showmessage">Server Error.</div>';
		jQuery('body').append(html);
		setTimeout(function(){jQuery('.showmessage').slideUp();},1000);
		return false;*/ 
	 }
			
   });
}
var platform='';
function fail(error) {
	jQuery('body .showmessage').remove();
	var html='<div class="showmessage" style="width:100%">Uploading error: Code = ' + error.code+', upload error source ' + error.source+', upload error target ' + error.target+'</div>';
	jQuery('body').append(html);
	setTimeout(function(){jQuery('.showmessage').slideUp();},3000);
}
function uploadgallerypic() {
	navigator.camera.getPicture(function(f) {
        var filetrasfer=f;
		if(filetrasfer!=''){
			//jQuery('.submitwrap img.justloading').remove();
			//jQuery('.submitwrap').append('<img src="images/ajax-loader.gif" class="justloading" />');
			jQuery('body .showmessage').remove();
			var html='<div class="showmessage">Please wait while uploading image...</div>';
			jQuery('body').append(html);
			var company_id=jQuery('input[name="company_id"]').val();
			var emergency_id=gup('id');
			var add_by=jQuery('input[name="add_by"]').val();
			var manager_id=jQuery('input[name="manager_id"]').val();
			var clinic_id=jQuery('input[name="clinic_id"]').val();
			
			resolveLocalFileSystemURL(filetrasfer, function(entry) {
			var filetrasfer2= entry.toURL();
			
			var uri = encodeURI(siteurl+'/api/emergencies/addemergencyimgmsg?company_id='+company_id+'&emergency_id='+emergency_id+'&add_by='+add_by+'&manager_id='+manager_id+'&clinic_id='+clinic_id);
			
			var options = new FileUploadOptions();
			options.fileKey="file";
			options.fileName=filetrasfer2.substr(filetrasfer2.lastIndexOf('/')+1);
			//options.mimeType="image/jpeg";
			var params = new Object();
			 params.value1 = "test";
			 params.value2 = "param";
			 options.params = params;
			 options.chunkedMode = false;
			var headers={'headerParam':'headerValue'};
			options.headers = headers;
			
			var ft = new FileTransfer();
			
			var t=ft.upload(filetrasfer2, uri, function(r){
					//jQuery('.submitwrap img.justloading').remove();
					var cntents=r.response.split('||emg||');
					//jQuery('.notelists').append('<div class="note-content"><span class="clinicnote">'+cntents[0]+'</span></div>');
					jQuery('.notelists').append('<div class="note-content"><span class="clinicnote"><div class="note-content">Me: <span class="img-wrape"><a href="javascript:;" onclick="return showimg(\''+filetrasfer+'\');"><i class="fa fa-picture-o" style="font-size:18px;"></i> Click to zoom</a></span><span class="seen_'+cntents[1]+' notseenmsg"></span></span></div>');
					jQuery('body .showmessage').remove();
					var html='<div class="showmessage">'+cntents[2]+'</div>';
					getgallerysinglenote(cntents[1],filetrasfer);
					jQuery('body').append(html);
					setTimeout(function(){jQuery('.showmessage').slideUp();},3000);
					if(typeof inter!='undefined'){
						clearInterval(inter);
					}
					var inter=setInterval(notes,5000);
					/*if(typeof inter3!='undefined'){
						clearInterval(inter3);
					}
					var inter3=setInterval(getemdetail,5000);*/
					if(typeof inter2!='undefined'){
						clearInterval(inter2);
					}
					var inter2=setInterval(checkseenmsg,6000);
						
			}, fail, options);
			});
		}
    }, function(e) {
    }, { 
        quality: 50,
        sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
        destinationType: Camera.DestinationType.FILE_URI,
		allowEdit:true
    });
    
}
function uploadmyvideo(){
	var filetrasfer=jQuery('#uploadvideopath').val();
	   jQuery('#emergency').modal();
	if(filetrasfer!=''){
		jQuery('#confirmuploadvideo').modal('hide');
		//jQuery('.submitwrap img.justloading').remove();
		//jQuery('.submitwrap').append('<img src="images/ajax-loader.gif" class="justloading" />');
		jQuery('body .showmessage').remove();
		var html='<div class="showmessage">Please wait while uploading video...</div>';
		jQuery('body').append(html);
		var company_id=jQuery('input[name="company_id"]').val();
		var emergency_id=jQuery('input[name="emergency_id"]').val();
		var add_by=jQuery('input[name="add_by"]').val();
		var manager_id=jQuery('input[name="manager_id"]').val();
		var clinic_id=jQuery('input[name="clinic_id"]:checked').val();
		var htt = "file://";
		if(filetrasfer.indexOf(htt) == '-1'){filetrasfer=htt+filetrasfer;}
			
		var successtranfer=function(entry) {
				var filetrasfer2= entry.toURL();
				
				var uri = encodeURI(siteurl+'/api/emergencies/saveemergencyivideo?company_id='+company_id+'&emergency_id='+emergency_id+'&add_by='+add_by+'&manager_id='+manager_id+'&clinic_id='+clinic_id);
				if(parseInt(emergency_id)!='' && parseInt(emergency_id)>0){
					uri = encodeURI(siteurl+'/api/emergencies/addemergencyvideomsg?company_id='+company_id+'&emergency_id='+emergency_id+'&add_by='+add_by+'&manager_id='+manager_id+'&clinic_id='+clinic_id);
				}
				var options = new FileUploadOptions();
				options.fileKey="file";
				options.fileName=filetrasfer2.substr(filetrasfer2.lastIndexOf('/')+1);
				//alert(options.fileName);
				options.mimeType="video/mp4";
				//var params = new Object();
				 //params.value1 = "test";
				 //params.value2 = "param";
				 //options.params = params;
				 options.chunkedMode = false;
				//var headers={'headerParam':'headerValue'};
				//options.headers = headers;
				
				var ft = new FileTransfer();
				
			
			var t=ft.upload(filetrasfer2, uri, function(r){
					//jQuery('.submitwrap img.justloading').remove();
					var cntents=r.response.split('||emg||');
					//jQuery('.notelists').append('<div class="note-content"><span class="clinicnote">'+cntents[0]+'</span></div>');
					jQuery('.notelists').append('<div class="note-content">Me: <span class="video-wrape"><a href="javascript:;" onclick="return showvideo(\''+filetrasfer+'\');"><img src="images/video1.png" alt="video" /> Click to view</a></span><span class="seen_'+cntents[1]+cls+' notseenmsg"></span></div>');
					jQuery('body .showmessage').remove();
					var html='<div class="showmessage">'+cntents[2]+'</div>';
					getgallerysinglenote(cntents[1],filetrasfer);
					jQuery('body').append(html);
					setTimeout(function(){jQuery('.showmessage').slideUp();},3000);
					if(parseInt(emergency_id)==0){
						jQuery('input[name="emergency_id"]').val(cntents[1]);
						jQuery('.submitwrap').append('<div class="pull-left"><a href="current-emergancy-detail.html?id='+cntents[1]+'" class="locationlink"><img src="images/locator.png" /></a></div>');
					}
					if(typeof inter!='undefined'){
						clearInterval(inter);
					}
					var inter=setInterval(notes,5000);
					setInterval(getemdetail,5000);
					setInterval(checkseenmsg,6000);
						
			}, fail, options);
		};
		resolveLocalFileSystemURL(filetrasfer, successtranfer, function(){});
    }
}
function uploadgalleryvideo() {
	navigator.camera.getPicture(function(f) {
        jQuery('#uploadvideopath').val(f);
       jQuery('#confirmuploadvideo').modal();
	   jQuery('#emergency').modal('hide');
	}, function(){}, { 
        quality: 50,
		sourceType: Camera.PictureSourceType.PHOTOLIBRARY,
		mediaType: Camera.MediaType.VIDEO,
		destinationType: Camera.DestinationType.FILE_URI
    });
    
}
function uploadcamerapic() {
	var captureSuccess = function(mediaFiles) {
		var i, path, len;
		for (i = 0, len = mediaFiles.length; i < len; i += 1) {
			path = mediaFiles[i].fullPath;
			if(platform!='Android'){
				var htt = "file:///";
				if(path.indexOf(htt) == '-1'){path=htt+path;}
			}
			var job_id=gup('job_id');
			var filetrasfer=path;
			
			if(filetrasfer!=''){
				//jQuery('.submitwrap img.justloading').remove();
				//jQuery('.submitwrap').append('<img src="images/ajax-loader.gif" class="justloading" />');
				jQuery('body .showmessage').remove();
				var html='<div class="showmessage">Please wait while uploading image...</div>';
				jQuery('body').append(html);
				var company_id=jQuery('input[name="company_id"]').val();
				var emergency_id=gup('id');
				var add_by=jQuery('input[name="add_by"]').val();
				var manager_id=jQuery('input[name="manager_id"]').val();
				var clinic_id=jQuery('input[name="clinic_id"]').val();	
				resolveLocalFileSystemURL(filetrasfer, function(entry) {
				var filetrasfer2= entry.toURL();
				var uri = encodeURI(siteurl+'/api/emergencies/saveemergencyimg?company_id='+company_id+'&emergency_id='+emergency_id+'&add_by='+add_by+'&manager_id='+manager_id+'&clinic_id='+clinic_id);
				if(parseInt(emergency_id)!='' && parseInt(emergency_id)>0){
					uri = encodeURI(siteurl+'/api/emergencies/addemergencyimgmsg?company_id='+company_id+'&emergency_id='+emergency_id+'&add_by='+add_by+'&manager_id='+manager_id+'&clinic_id='+clinic_id);
				}
				var options = new FileUploadOptions();
				options.fileKey="file";
				options.fileName=filetrasfer2.substr(filetrasfer2.lastIndexOf('/')+1);
				//options.mimeType="image/jpeg";
				var params = new Object();
				 params.value1 = "test";
				 params.value2 = "param";
				 options.params = params;
				 options.chunkedMode = false;
				var headers={'headerParam':'headerValue'};
				options.headers = headers;
				
				var ft = new FileTransfer();
				
				var t=ft.upload(filetrasfer2, uri, function(r){
					//jQuery('.submitwrap img.justloading').remove();
					var cntents=r.response.split('||emg||');
					//jQuery('.notelists').append('<div class="note-content"><span class="clinicnote">'+cntents[0]+'</span></div>');
					jQuery('.notelists').append('<div class="note-content"><span class="clinicnote"><div class="note-content">Me: <span class="img-wrape"><a href="javascript:;" onclick="return showimg(\''+filetrasfer+'\');"><i class="fa fa-picture-o" style="font-size:18px;"></i> Click to zoom</a></span><span class="seen_'+cntents[1]+' notseenmsg"></span></span></div>');
					jQuery('body .showmessage').remove();
					var html='<div class="showmessage">'+cntents[2]+'</div>';
					getgallerysinglenote(cntents[1],filetrasfer);
					jQuery('body').append(html);
					setTimeout(function(){jQuery('.showmessage').slideUp();},3000);
					if(typeof inter!='undefined'){
						clearInterval(inter);
					}
					var inter=setInterval(notes,5000);
					/*if(typeof inter3!='undefined'){
						clearInterval(inter3);
					}
					var inter3=setInterval(getemdetail,5000);*/
					if(typeof inter2!='undefined'){
						clearInterval(inter2);
					}
					var inter2=setInterval(checkseenmsg,6000);
				}, fail, options);
				});
			}
		}
	};
	// capture error callback
	var captureError = function(error) {
		navigator.notification.alert('Error code: ' + error.code, null, 'Capture Error');
	};
	navigator.device.capture.captureImage(captureSuccess, captureError, {limit:1});
    
    
}
document.addEventListener("deviceready", uploadpic, false);
function uploadpic() {
	platform=device.platform;
	jQuery("#uploadphoto1").on("touchend", uploadcamerapic);
	jQuery("#uploadphoto12").on("touchend", uploadgallerypic);
	jQuery("#uploadphoto13").on("touchend", uploadgalleryvideo);
}

</script>
</body>
</html>
